<?php

/**
 * Implements hook_library_info_alter().
 */
function makerspace_dashboard_library_info_alter(array &$libraries, $extension) {
  if ($extension === 'views_slideshow_cycle' && isset($libraries['views_slideshow_cycle'])) {
    $json_key = '/libraries/json2/json2.js';
    if (isset($libraries['views_slideshow_cycle']['js'][$json_key])) {
      $json_path = DRUPAL_ROOT . $json_key;
      if (!file_exists($json_path)) {
        // Swap in a CDN-backed JSON2 variant when the local library is absent.
        unset($libraries['views_slideshow_cycle']['js'][$json_key]);
        $libraries['views_slideshow_cycle']['js']['https://cdnjs.cloudflare.com/ajax/libs/json2/20160501/json2.min.js'] = [
          'type' => 'external',
        ];
      }
    }
  }
}

use Drupal\Core\Form\FormStateInterface;

/**
 * Move Chart.js pie/doughnut legends to TOP (workaround for 4.4.x bug).
 */
function makerspace_dashboard_charts_process_alter(array &$build, FormStateInterface $form_state): void {
  if (empty($build['#chart'])) {
    return;
  }
  $lib  = $build['#chart']['library'] ?? '';
  $type = $build['#chart']['type'] ?? '';
  if ($lib === 'chartjs' && in_array($type, ['pie', 'doughnut'], true)) {
    $build['#chart']['options']['plugins']['legend']['position'] = 'top';
  }

  if (!empty($build['#chart']['data']['labels']) && is_array($build['#chart']['data']['labels'])) {
    $build['#chart']['data']['labels'] = array_map('strval', $build['#chart']['data']['labels']);
  }
}

/**
 * Implements hook_makerspace_snapshot_collect_kpi().
 */
function makerspace_dashboard_makerspace_snapshot_collect_kpi(array $context): array {
  $metrics = [];

  if (isset($context['members_active'])) {
    $metrics['total_active_members'] = [
      'value' => (int) $context['members_active'],
      'period_year' => (int) date('Y', strtotime($context['snapshot_date'])),
      'period_month' => (int) date('n', strtotime($context['snapshot_date'])),
    ];
  }

  return $metrics;
}

/**
 * Implements hook_theme().
 */
function makerspace_dashboard_theme($existing, $type, $theme, $path) {
  return [
    'annual_report' => [
      'variables' => [
        'title' => NULL,
        'description' => NULL,
        'notice' => NULL,
        'rows' => [],
        'tables' => [],
        'charts' => [],
      ],
    ],
  ];
}
