<?php

/**
 * Implements hook_library_info_alter().
 */
function makerspace_dashboard_library_info_alter(array &$libraries, $extension) {
  if ($extension === 'views_slideshow_cycle' && isset($libraries['views_slideshow_cycle'])) {
    $json_key = '/libraries/json2/json2.js';
    if (isset($libraries['views_slideshow_cycle']['js'][$json_key])) {
      $json_path = DRUPAL_ROOT . $json_key;
      if (!file_exists($json_path)) {
        // Swap in a CDN-backed JSON2 variant when the local library is absent.
        unset($libraries['views_slideshow_cycle']['js'][$json_key]);
        $libraries['views_slideshow_cycle']['js']['https://cdnjs.cloudflare.com/ajax/libs/json2/20160501/json2.min.js'] = [
          'type' => 'external',
        ];
      }
    }
  }
}

use Drupal\Core\Form\FormStateInterface;

/**
 * Move Chart.js pie/doughnut legends to TOP (workaround for 4.4.x bug).
 */
function makerspace_dashboard_charts_process_alter(array &$build, FormStateInterface $form_state): void {
  if (empty($build['#chart'])) {
    return;
  }
  $lib  = $build['#chart']['library'] ?? '';
  $type = $build['#chart']['type'] ?? '';
  if ($lib === 'chartjs' && in_array($type, ['pie', 'doughnut'], true)) {
    $build['#chart']['options']['plugins']['legend']['position'] = 'top';
  }

  if (!empty($build['#chart']['data']['labels']) && is_array($build['#chart']['data']['labels'])) {
    $build['#chart']['data']['labels'] = array_map('strval', $build['#chart']['data']['labels']);
  }
}

/**
 * Implements hook_makerspace_snapshot_collect_kpi().
 */
function makerspace_dashboard_makerspace_snapshot_collect_kpi(array $context): array {
  $metrics = [];
  $snapshotTimestamp = !empty($context['snapshot_date']) ? strtotime((string) $context['snapshot_date']) : \Drupal::time()->getRequestTime();
  $periodYear = (int) date('Y', $snapshotTimestamp);
  $periodMonth = (int) date('n', $snapshotTimestamp);

  if (isset($context['members_active'])) {
    $metrics['total_active_members'] = [
      'value' => (int) $context['members_active'],
      'period_year' => $periodYear,
      'period_month' => $periodMonth,
    ];
  }

  // Snapshot point-in-time utilization so membership-denominator math is frozen.
  if (!empty($context['period_start']) && !empty($context['period_end']) && \Drupal::hasService('makerspace_dashboard.utilization_data')) {
    try {
      $startTs = strtotime((string) $context['period_start']) ?: NULL;
      $endTs = strtotime((string) $context['period_end']) ?: NULL;
      if ($startTs && $endTs && $endTs >= $startTs) {
        $buckets = \Drupal::service('makerspace_dashboard.utilization_data')->getVisitFrequencyBuckets($startTs, $endTs);
        $bucketTotal = 0;
        foreach ($buckets as $bucketCount) {
          if (is_numeric($bucketCount)) {
            $bucketTotal += (int) $bucketCount;
          }
        }
        $noVisits = isset($buckets['no_visits']) && is_numeric($buckets['no_visits']) ? (int) $buckets['no_visits'] : 0;
        $participants = max(0, $bucketTotal - $noVisits);
        $participationRatio = $bucketTotal > 0 ? ($participants / $bucketTotal) : 0.0;

        $metrics['shop_utilization'] = [
          'value' => $participationRatio,
          'period_year' => $periodYear,
          'period_month' => $periodMonth,
        ];
        // Keep legacy KPI ID aligned to the same frozen denominator.
        $metrics['active_participation'] = [
          'value' => $participationRatio,
          'period_year' => $periodYear,
          'period_month' => $periodMonth,
        ];
      }
    }
    catch (\Exception $e) {
      \Drupal::logger('makerspace_dashboard')->error('Unable to snapshot utilization KPI metrics: @message', ['@message' => $e->getMessage()]);
    }
  }

  // Snapshot demographic state + join/cancel flow to prevent historical drift.
  if (!empty($context['period_start']) && !empty($context['period_end']) && \Drupal::hasService('makerspace_dashboard.demographics_data')) {
    try {
      $start = new \DateTimeImmutable((string) $context['period_start']);
      $end = new \DateTimeImmutable((string) $context['period_end']);
      $demographics = \Drupal::service('makerspace_dashboard.demographics_data');

      $active = $demographics->getActiveBipocSnapshot();
      $activeReported = (int) ($active['reported_members'] ?? 0);
      $activeBipoc = (int) ($active['bipoc_members'] ?? 0);
      $activeRate = $activeReported > 0 ? ($activeBipoc / $activeReported) : 0.0;

      $metrics['membership_diversity_bipoc'] = [
        'value' => $activeRate,
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];
      $metrics['active_members_reported_ethnicity_count'] = [
        'value' => $activeReported,
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];
      $metrics['active_members_bipoc_count'] = [
        'value' => $activeBipoc,
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];

      $flow = $demographics->getEthnicityFlowSnapshot($start, $end);
      $metrics['joins_reported_ethnicity_count'] = [
        'value' => (int) ($flow['joins_reported'] ?? 0),
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];
      $metrics['joins_bipoc_count'] = [
        'value' => (int) ($flow['joins_bipoc'] ?? 0),
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];
      $metrics['joins_bipoc_rate'] = [
        'value' => (float) ($flow['joins_bipoc_rate'] ?? 0.0),
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];
      $metrics['cancels_reported_ethnicity_count'] = [
        'value' => (int) ($flow['cancels_reported'] ?? 0),
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];
      $metrics['cancels_bipoc_count'] = [
        'value' => (int) ($flow['cancels_bipoc'] ?? 0),
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];
      $metrics['cancels_bipoc_rate'] = [
        'value' => (float) ($flow['cancels_bipoc_rate'] ?? 0.0),
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];
    }
    catch (\Exception $e) {
      \Drupal::logger('makerspace_dashboard')->error('Unable to snapshot demographic KPI metrics: @message', ['@message' => $e->getMessage()]);
    }
  }

  return $metrics;
}

/**
 * Implements hook_theme().
 */
function makerspace_dashboard_theme($existing, $type, $theme, $path) {
  return [
    'annual_report' => [
      'variables' => [
        'title' => NULL,
        'description' => NULL,
        'notice' => NULL,
        'rows' => [],
        'tables' => [],
        'charts' => [],
      ],
    ],
  ];
}
