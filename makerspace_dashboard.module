<?php

/**
 * Implements hook_library_info_alter().
 */
function makerspace_dashboard_library_info_alter(array &$libraries, $extension) {
  if ($extension === 'views_slideshow_cycle' && isset($libraries['views_slideshow_cycle'])) {
    $json_key = '/libraries/json2/json2.js';
    if (isset($libraries['views_slideshow_cycle']['js'][$json_key])) {
      $json_path = DRUPAL_ROOT . $json_key;
      if (!file_exists($json_path)) {
        // Swap in a CDN-backed JSON2 variant when the local library is absent.
        unset($libraries['views_slideshow_cycle']['js'][$json_key]);
        $libraries['views_slideshow_cycle']['js']['https://cdnjs.cloudflare.com/ajax/libs/json2/20160501/json2.min.js'] = [
          'type' => 'external',
        ];
      }
    }
  }

}

use Drupal\Core\Form\FormStateInterface;

/**
 * Move Chart.js pie/doughnut legends to TOP (workaround for 4.4.x bug).
 */
function makerspace_dashboard_charts_process_alter(array &$build, FormStateInterface $form_state): void {
  if (empty($build['#chart'])) {
    return;
  }
  $lib  = $build['#chart']['library'] ?? '';
  $type = $build['#chart']['type'] ?? '';
  if ($lib === 'chartjs' && in_array($type, ['pie', 'doughnut'], true)) {
    $build['#chart']['options']['plugins']['legend']['position'] = 'top';
  }

  if (!empty($build['#chart']['data']['labels']) && is_array($build['#chart']['data']['labels'])) {
    $build['#chart']['data']['labels'] = array_map('strval', $build['#chart']['data']['labels']);
  }
}

/**
 * Implements hook_makerspace_snapshot_collect_kpi().
 */
function makerspace_dashboard_makerspace_snapshot_collect_kpi(array $context): array {
  $metrics = [];
  $snapshotTimestamp = !empty($context['snapshot_date']) ? strtotime((string) $context['snapshot_date']) : \Drupal::time()->getRequestTime();
  $periodYear = (int) date('Y', $snapshotTimestamp);
  $periodMonth = (int) date('n', $snapshotTimestamp);

  if (isset($context['members_active'])) {
    $metrics['kpi_total_active_members'] = [
      'value' => (int) $context['members_active'],
      'period_year' => $periodYear,
      'period_month' => $periodMonth,
    ];
  }
  if (isset($context['joins']) && is_numeric($context['joins'])) {
    $metrics['kpi_total_new_member_signups'] = [
      'value' => (int) $context['joins'],
      'period_year' => $periodYear,
      'period_month' => $periodMonth,
    ];
  }

  $periodStart = NULL;
  $periodEnd = NULL;
  if (!empty($context['period_start']) && !empty($context['period_end'])) {
    try {
      $periodStart = new \DateTimeImmutable((string) $context['period_start']);
      $periodEnd = new \DateTimeImmutable((string) $context['period_end']);
    }
    catch (\Exception $e) {
      $periodStart = NULL;
      $periodEnd = NULL;
    }
  }

  // Snapshot point-in-time utilization so membership-denominator math is frozen.
  if (!empty($context['period_start']) && !empty($context['period_end']) && \Drupal::hasService('makerspace_dashboard.utilization_data')) {
    try {
      $startTs = strtotime((string) $context['period_start']) ?: NULL;
      $endTs = strtotime((string) $context['period_end']) ?: NULL;
      if ($startTs && $endTs && $endTs >= $startTs) {
        $buckets = \Drupal::service('makerspace_dashboard.utilization_data')->getVisitFrequencyBuckets($startTs, $endTs);
        $bucketTotal = 0;
        foreach ($buckets as $bucketCount) {
          if (is_numeric($bucketCount)) {
            $bucketTotal += (int) $bucketCount;
          }
        }
        $noVisits = isset($buckets['no_visits']) && is_numeric($buckets['no_visits']) ? (int) $buckets['no_visits'] : 0;
        $participants = max(0, $bucketTotal - $noVisits);
        $participationRatio = $bucketTotal > 0 ? ($participants / $bucketTotal) : 0.0;

        $metrics['kpi_shop_utilization'] = [
          'value' => $participationRatio,
          'period_year' => $periodYear,
          'period_month' => $periodMonth,
        ];
        // Keep legacy KPI ID aligned to the same frozen denominator.
        $metrics['kpi_active_participation'] = [
          'value' => $participationRatio,
          'period_year' => $periodYear,
          'period_month' => $periodMonth,
        ];
      }
    }
    catch (\Exception $e) {
      \Drupal::logger('makerspace_dashboard')->error('Unable to snapshot utilization KPI metrics: @message', ['@message' => $e->getMessage()]);
    }
  }

  // Snapshot demographic state + join/cancel flow to prevent historical drift.
  if (!empty($context['period_start']) && !empty($context['period_end']) && \Drupal::hasService('makerspace_dashboard.demographics_data')) {
    try {
      $start = new \DateTimeImmutable((string) $context['period_start']);
      $end = new \DateTimeImmutable((string) $context['period_end']);
      $demographics = \Drupal::service('makerspace_dashboard.demographics_data');

      $active = $demographics->getActiveBipocSnapshot();
      $activeReported = (int) ($active['reported_members'] ?? 0);
      $activeBipoc = (int) ($active['bipoc_members'] ?? 0);
      $activeRate = $activeReported > 0 ? ($activeBipoc / $activeReported) : 0.0;

      $metrics['kpi_membership_diversity_bipoc'] = [
        'value' => $activeRate,
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];
      $metrics['active_members_reported_ethnicity_count'] = [
        'value' => $activeReported,
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];
      $metrics['active_members_bipoc_count'] = [
        'value' => $activeBipoc,
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];

      $flow = $demographics->getEthnicityFlowSnapshot($start, $end);
      $metrics['joins_reported_ethnicity_count'] = [
        'value' => (int) ($flow['joins_reported'] ?? 0),
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];
      $metrics['joins_bipoc_count'] = [
        'value' => (int) ($flow['joins_bipoc'] ?? 0),
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];
      $metrics['joins_bipoc_rate'] = [
        'value' => (float) ($flow['joins_bipoc_rate'] ?? 0.0),
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];
      $metrics['cancels_reported_ethnicity_count'] = [
        'value' => (int) ($flow['cancels_reported'] ?? 0),
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];
      $metrics['cancels_bipoc_count'] = [
        'value' => (int) ($flow['cancels_bipoc'] ?? 0),
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];
      $metrics['cancels_bipoc_rate'] = [
        'value' => (float) ($flow['cancels_bipoc_rate'] ?? 0.0),
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];
    }
    catch (\Exception $e) {
      \Drupal::logger('makerspace_dashboard')->error('Unable to snapshot demographic KPI metrics: @message', ['@message' => $e->getMessage()]);
    }
  }

  // Snapshot outreach and education KPI metrics for annual table population.
  if ($periodStart && $periodEnd && \Drupal::hasService('makerspace_dashboard.events_membership_data')) {
    try {
      $eventsService = \Drupal::service('makerspace_dashboard.events_membership_data');

      $attendanceSeries = $eventsService->getMonthlyWorkshopAttendanceSeries($periodStart, $periodEnd);
      $workshopAttendees = makerspace_dashboard_sum_count_items((array) ($attendanceSeries['items'] ?? []));
      $metrics['kpi_workshop_attendees'] = [
        'value' => $workshopAttendees,
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];

      $firstTimeSeries = $eventsService->getMonthlyFirstTimeWorkshopParticipantsSeries($periodStart, $periodEnd);
      $firstTimeParticipants = makerspace_dashboard_sum_count_items((array) ($firstTimeSeries['items'] ?? []));
      $metrics['kpi_total_first_time_workshop_participants'] = [
        'value' => $firstTimeParticipants,
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];

      $participantDemo = $eventsService->getParticipantDemographics($periodStart, $periodEnd);
      $workshopBipocRate = makerspace_dashboard_calculate_workshop_bipoc_rate((array) $participantDemo);
      if ($workshopBipocRate !== NULL) {
        $metrics['kpi_workshop_participants_bipoc'] = [
          'value' => $workshopBipocRate,
          'period_year' => $periodYear,
          'period_month' => $periodMonth,
        ];
      }

      $instructorDemo = $eventsService->getActiveInstructorDemographics($periodStart, $periodEnd);
      $instructorBipocRate = makerspace_dashboard_calculate_instructor_bipoc_rate((array) $instructorDemo);
      if ($instructorBipocRate !== NULL) {
        $metrics['kpi_active_instructors_bipoc'] = [
          'value' => $instructorBipocRate,
          'period_year' => $periodYear,
          'period_month' => $periodMonth,
        ];
      }
    }
    catch (\Exception $e) {
      \Drupal::logger('makerspace_dashboard')->error('Unable to snapshot outreach/education event KPIs: @message', ['@message' => $e->getMessage()]);
    }
  }

  if ($periodStart && $periodEnd && \Drupal::hasService('makerspace_dashboard.education_evaluation_data')) {
    try {
      $evaluationService = \Drupal::service('makerspace_dashboard.education_evaluation_data');
      $npsSeries = $evaluationService->getNetPromoterSeries($periodStart, $periodEnd);
      $overallNps = $npsSeries['overall']['nps'] ?? NULL;
      if (is_numeric($overallNps)) {
        $metrics['kpi_education_nps'] = [
          'value' => (float) $overallNps,
          'period_year' => $periodYear,
          'period_month' => $periodMonth,
        ];
      }
    }
    catch (\Exception $e) {
      \Drupal::logger('makerspace_dashboard')->error('Unable to snapshot education NPS KPI: @message', ['@message' => $e->getMessage()]);
    }
  }

  if (\Drupal::hasService('makerspace_dashboard.funnel_data')) {
    try {
      $funnelService = \Drupal::service('makerspace_dashboard.funnel_data');

      $tourFunnel = $funnelService->getTourFunnelData();
      $tourParticipants = (int) ($tourFunnel['participants'] ?? 0);
      $tourConversions = (int) ($tourFunnel['conversions'] ?? 0);
      if ($tourParticipants > 0) {
        $metrics['kpi_tours_to_member_conversion'] = [
          'value' => $tourConversions / $tourParticipants,
          'period_year' => $periodYear,
          'period_month' => $periodMonth,
        ];
      }

      $meetingFunnel = $funnelService->getActivityFunnelData('meeting');
      $meetingActivities = (int) ($meetingFunnel['activities'] ?? 0);
      $meetingConversions = (int) ($meetingFunnel['conversions'] ?? 0);
      if ($meetingActivities > 0) {
        $metrics['meeting_to_member_conversion'] = [
          'value' => $meetingConversions / $meetingActivities,
          'period_year' => $periodYear,
          'period_month' => $periodMonth,
        ];
      }
    }
    catch (\Exception $e) {
      \Drupal::logger('makerspace_dashboard')->error('Unable to snapshot outreach funnel KPIs: @message', ['@message' => $e->getMessage()]);
    }
  }

  if ($periodStart && $periodEnd && \Drupal::hasService('makerspace_dashboard.funnel_data')) {
    try {
      $funnelService = \Drupal::service('makerspace_dashboard.funnel_data');
      $metrics['kpi_tours'] = [
        'value' => $funnelService->getTourParticipantCount($periodStart, $periodEnd),
        'period_year' => $periodYear,
        'period_month' => $periodMonth,
      ];
    }
    catch (\Exception $e) {
      \Drupal::logger('makerspace_dashboard')->error('Unable to snapshot tour participant KPI: @message', ['@message' => $e->getMessage()]);
    }
  }

  return $metrics;
}

/**
 * Sums a list of KPI series items containing a numeric "count" field.
 */
function makerspace_dashboard_sum_count_items(array $items): int {
  $sum = 0;
  foreach ($items as $item) {
    $value = $item['count'] ?? NULL;
    if (is_numeric($value)) {
      $sum += (int) $value;
    }
  }
  return $sum;
}

/**
 * Calculates workshop participant BIPOC rate from demographics payload.
 */
function makerspace_dashboard_calculate_workshop_bipoc_rate(array $participant_demo): ?float {
  $labels = (array) ($participant_demo['ethnicity']['labels'] ?? []);
  $workshop = (array) ($participant_demo['ethnicity']['workshop'] ?? []);
  if (empty($labels) || empty($workshop)) {
    return NULL;
  }

  $knownCount = 0.0;
  $bipocCount = 0.0;
  foreach ($labels as $index => $label) {
    $count = isset($workshop[$index]) && is_numeric($workshop[$index]) ? (float) $workshop[$index] : 0.0;
    if ($count <= 0) {
      continue;
    }
    if (makerspace_dashboard_is_unspecified_ethnicity((string) $label)) {
      continue;
    }
    $knownCount += $count;
    if (makerspace_dashboard_is_bipoc_ethnicity_label((string) $label)) {
      $bipocCount += $count;
    }
  }

  return $knownCount > 0 ? ($bipocCount / $knownCount) : NULL;
}

/**
 * Calculates active instructor BIPOC rate from demographics payload.
 */
function makerspace_dashboard_calculate_instructor_bipoc_rate(array $instructor_demo): ?float {
  $instructors = (array) ($instructor_demo['instructors'] ?? []);
  if (empty($instructors)) {
    return NULL;
  }

  $knownCount = 0;
  $bipocCount = 0;
  foreach ($instructors as $instructor) {
    $ethnicities = array_unique(array_filter(array_map('strval', (array) ($instructor['ethnicity'] ?? []))));
    if (empty($ethnicities)) {
      continue;
    }

    $hasKnown = FALSE;
    $hasBipoc = FALSE;
    foreach ($ethnicities as $label) {
      if (makerspace_dashboard_is_unspecified_ethnicity($label)) {
        continue;
      }
      $hasKnown = TRUE;
      if (makerspace_dashboard_is_bipoc_ethnicity_label($label)) {
        $hasBipoc = TRUE;
      }
    }

    if (!$hasKnown) {
      continue;
    }
    $knownCount++;
    if ($hasBipoc) {
      $bipocCount++;
    }
  }

  return $knownCount > 0 ? ($bipocCount / $knownCount) : NULL;
}

/**
 * Determines whether an ethnicity label should be treated as unspecified.
 */
function makerspace_dashboard_is_unspecified_ethnicity(string $label): bool {
  $normalized = strtolower(trim($label));
  if ($normalized === '') {
    return TRUE;
  }

  $unspecifiedTokens = [
    'unspecified',
    'unknown',
    'prefer not',
    'decline',
    'not provided',
    'n/a',
  ];
  foreach ($unspecifiedTokens as $token) {
    if (str_contains($normalized, $token)) {
      return TRUE;
    }
  }

  return FALSE;
}

/**
 * Determines whether an ethnicity label should be counted as BIPOC.
 */
function makerspace_dashboard_is_bipoc_ethnicity_label(string $label): bool {
  $normalized = strtolower(trim($label));
  if (makerspace_dashboard_is_unspecified_ethnicity($normalized)) {
    return FALSE;
  }
  return !str_contains($normalized, 'white');
}

/**
 * Implements hook_theme().
 */
function makerspace_dashboard_theme($existing, $type, $theme, $path) {
  return [
    'annual_report' => [
      'variables' => [
        'title' => NULL,
        'description' => NULL,
        'notice' => NULL,
        'rows' => [],
        'tables' => [],
        'charts' => [],
      ],
    ],
  ];
}
